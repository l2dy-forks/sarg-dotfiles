#+PROPERTY: tangle bootstrap.sh
Notes:
1. partition labels should match those in operating-system fr
2. root partition should be named Guix_image as it's hardcoded in install-efi-loader
3. efi partition is named GNU-ESP just to match the name of =esp-partition=

* Back up
#+begin_src sh
cd /media/sarg/500GB
rsync --no-checksum -a --info=progress2 --exclude=.avfs /home/sarg sarg
rsync --no-checksum -a --info=progress2 /storage .
#+end_src

* Preparing disk image
#+begin_src sh
cp $(guix system image ~/devel/dotfiles/guix/image.scm) \
    /media/sarg/500GB/thinkpad.img
#+end_src

cp result to usb stick

* Deploying image to a target machine
Boot from live cd

#+begin_src sh
dd thinkpad.img of=/dev/sda status=progress

parted /dev/sda print
# Warning: Not all of the space available to /dev/sda appears to be used, you
# can fix the GPT to use all of the space (an extra 346740088 blocks) or
# continue with the current setting?
# Fix/Ignore? fix

parted -s /dev/sda resizepart 2 60g mkpart STORAGE ext4 60g 100%
fsck /dev/sda2
resize2fs /dev/sda2
mkfs.ext4 /dev/sda3 -L STORAGE
#+end_src

mount storage, rsync it from backup
#+begin_src sh
mkdir /storage
mount /dev/sda3 /storage
cd /storage
rsync -a --info=progress2 /mnt/backup/storage/ .
#+end_src

#+begin_src sh
reboot
#+end_src

* Initial setup
log in as root (empty pass)

#+begin_src sh
passwd sarg
logout
#+end_src

log in as sarg
#+begin_src shell
cd /storage/devel/dotfiles/guix
guix pull -C channels.scm
sudo guix system reconfigure system.scm
guix home reconfigure home.scm

doom sync
mu init -m ~/.mail
mu index
#+end_src
